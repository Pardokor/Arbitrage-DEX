import React, { useState, useEffect } from 'react';
import { RefreshCw, TrendingUp, TrendingDown, ArrowRight, AlertCircle } from 'lucide-react';

const App = () => {
  const [markets, setMarkets] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [lastUpdate, setLastUpdate] = useState(null);
  const [sortBy, setSortBy] = useState('spread');
  const [minSpread, setMinSpread] = useState(0);

  const fetchMarkets = async () => {
    setLoading(true);
    setError(null);
    
    try {
      // Fetch Paradex markets
      const paradexResponse = await fetch('https://api.prod.paradex.trade/v1/markets');
      const paradexData = await paradexResponse.json();
      
      // Fetch Extended markets
      const extendedResponse = await fetch('https://api.starknet.extended.exchange/api/v1/info/markets');
      const extendedData = await extendedResponse.json();
      
      if (paradexData.results && extendedData.data) {
        const combinedMarkets = processMarkets(paradexData.results, extendedData.data);
        setMarkets(combinedMarkets);
        setLastUpdate(new Date());
      }
    } catch (err) {
      setError('Erreur lors de la récupération des données: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  const processMarkets = (paradexMarkets, extendedMarkets) => {
    const combined = [];
    
    paradexMarkets.forEach(pMarket => {
      const baseName = pMarket.symbol.replace('-PERP', '').replace('USDC', 'USD');
      const extMarket = extendedMarkets.find(e => 
        e.name === baseName || 
        e.name === pMarket.symbol.replace('-PERP', '') ||
        e.assetName === baseName.split('-')[0]
      );
      
      if (extMarket && pMarket.market_price && extMarket.marketStats?.lastPrice) {
        const paradexPrice = parseFloat(pMarket.market_price);
        const extendedPrice = parseFloat(extMarket.marketStats.lastPrice);
        
        if (paradexPrice > 0 && extendedPrice > 0) {
          const spread = ((paradexPrice - extendedPrice) / extendedPrice) * 100;
          const volume24h = parseFloat(pMarket.volume_24) || 0;
          
          combined.push({
            symbol: baseName,
            paradex: {
              price: paradexPrice,
              volume: volume24h,
              bid: parseFloat(pMarket.best_bid) || paradexPrice,
              ask: parseFloat(pMarket.best_ask) || paradexPrice
            },
            extended: {
              price: extendedPrice,
              volume: parseFloat(extMarket.marketStats.dailyVolume || 0),
              bid: parseFloat(extMarket.marketStats.bidPrice || extendedPrice),
              ask: parseFloat(extMarket.marketStats.askPrice || extendedPrice)
            },
            spread: spread,
            absSpread: Math.abs(spread),
            direction: spread > 0 ? 'extended-to-paradex' : 'paradex-to-extended'
          });
        }
      }
    });
    
    return combined;
  };

  useEffect(() => {
    fetchMarkets();
    const interval = setInterval(fetchMarkets, 30000);
    return () => clearInterval(interval);
  }, []);

  const sortedMarkets = [...markets]
    .filter(m => m.absSpread >= minSpread)
    .sort((a, b) => {
      if (sortBy === 'spread') return b.absSpread - a.absSpread;
      if (sortBy === 'symbol') return a.symbol.localeCompare(b.symbol);
      return 0;
    });

  const formatPrice = (price) => {
    if (price >= 1000) return price.toFixed(2);
    if (price >= 1) return price.toFixed(4);
    return price.toFixed(6);
  };

  const formatVolume = (volume) => {
    if (volume >= 1e9) return (volume / 1e9).toFixed(2) + 'B';
    if (volume >= 1e6) return (volume / 1e6).toFixed(2) + 'M';
    if (volume >= 1e3) return (volume / 1e3).toFixed(2) + 'K';
    return volume.toFixed(2);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      <div className="container mx-auto px-4 py-8 max-w-7xl">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-white mb-2 flex items-center justify-center gap-3">
            <TrendingUp className="text-green-400" size={36} />
            Arbitrage DEX
          </h1>
          <p className="text-purple-200">Paradex vs Extended Exchange</p>
        </div>

        {/* Controls */}
        <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 shadow-2xl border border-white/20">
          <div className="flex flex-wrap gap-4 items-center justify-between">
            <div className="flex gap-4 items-center">
              <button
                onClick={fetchMarkets}
                disabled={loading}
                className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 text-white px-4 py-2 rounded-lg transition-all"
              >
                <RefreshCw className={loading ? 'animate-spin' : ''} size={18} />
                Actualiser
              </button>
              
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
                className="bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-600"
              >
                <option value="spread">Trier par spread</option>
                <option value="symbol">Trier par symbole</option>
              </select>

              <div className="flex items-center gap-2">
                <label className="text-white text-sm">Spread min:</label>
                <input
                  type="number"
                  value={minSpread}
                  onChange={(e) => setMinSpread(parseFloat(e.target.value) || 0)}
                  step="0.1"
                  className="bg-slate-800 text-white px-3 py-2 rounded-lg w-24 border border-slate-600"
                />
                <span className="text-white">%</span>
              </div>
            </div>

            {lastUpdate && (
              <div className="text-purple-200 text-sm">
                Dernière mise à jour: {lastUpdate.toLocaleTimeString('fr-FR')}
              </div>
            )}
          </div>
        </div>

        {error && (
          <div className="bg-red-500/20 border border-red-500 rounded-lg p-4 mb-6 flex items-center gap-3">
            <AlertCircle className="text-red-400" size={24} />
            <p className="text-red-200">{error}</p>
          </div>
        )}

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
            <div className="text-purple-200 text-sm mb-1">Paires disponibles</div>
            <div className="text-3xl font-bold text-white">{sortedMarkets.length}</div>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
            <div className="text-purple-200 text-sm mb-1">Spread moyen</div>
            <div className="text-3xl font-bold text-white">
              {sortedMarkets.length > 0
                ? (sortedMarkets.reduce((acc, m) => acc + m.absSpread, 0) / sortedMarkets.length).toFixed(2)
                : '0.00'}%
            </div>
          </div>
          <div className="bg-white/10 backdrop-blur-lg rounded-xl p-4 border border-white/20">
            <div className="text-purple-200 text-sm mb-1">Spread max</div>
            <div className="text-3xl font-bold text-white">
              {sortedMarkets.length > 0
                ? sortedMarkets[0].absSpread.toFixed(2)
                : '0.00'}%
            </div>
          </div>
        </div>

        {/* Markets Table */}
        <div className="bg-white/10 backdrop-blur-lg rounded-xl overflow-hidden shadow-2xl border border-white/20">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-black/30">
                <tr>
                  <th className="px-6 py-4 text-left text-purple-200 font-semibold">Paire</th>
                  <th className="px-6 py-4 text-right text-purple-200 font-semibold">Paradex</th>
                  <th className="px-6 py-4 text-center text-purple-200 font-semibold">Direction</th>
                  <th className="px-6 py-4 text-right text-purple-200 font-semibold">Extended</th>
                  <th className="px-6 py-4 text-right text-purple-200 font-semibold">Spread</th>
                  <th className="px-6 py-4 text-right text-purple-200 font-semibold">Volume 24h</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-white/10">
                {loading && sortedMarkets.length === 0 ? (
                  <tr>
                    <td colSpan="6" className="px-6 py-12 text-center text-purple-200">
                      <RefreshCw className="animate-spin mx-auto mb-2" size={32} />
                      Chargement des données...
                    </td>
                  </tr>
                ) : sortedMarkets.length === 0 ? (
                  <tr>
                    <td colSpan="6" className="px-6 py-12 text-center text-purple-200">
                      Aucune opportunité d'arbitrage trouvée
                    </td>
                  </tr>
                ) : (
                  sortedMarkets.map((market, idx) => (
                    <tr key={idx} className="hover:bg-white/5 transition-colors">
                      <td className="px-6 py-4">
                        <div className="font-bold text-white text-lg">{market.symbol}</div>
                      </td>
                      <td className="px-6 py-4 text-right">
                        <div className="text-white font-semibold">${formatPrice(market.paradex.price)}</div>
                        <div className="text-xs text-purple-300">
                          Bid: ${formatPrice(market.paradex.bid)} | Ask: ${formatPrice(market.paradex.ask)}
                        </div>
                      </td>
                      <td className="px-6 py-4 text-center">
                        <div className="flex items-center justify-center">
                          {market.spread > 0 ? (
                            <div className="flex items-center gap-2 text-green-400">
                              <span className="text-sm">Extended</span>
                              <ArrowRight size={20} />
                              <span className="text-sm">Paradex</span>
                            </div>
                          ) : (
                            <div className="flex items-center gap-2 text-blue-400">
                              <span className="text-sm">Paradex</span>
                              <ArrowRight size={20} />
                              <span className="text-sm">Extended</span>
                            </div>
                          )}
                        </div>
                      </td>
                      <td className="px-6 py-4 text-right">
                        <div className="text-white font-semibold">${formatPrice(market.extended.price)}</div>
                        <div className="text-xs text-purple-300">
                          Bid: ${formatPrice(market.extended.bid)} | Ask: ${formatPrice(market.extended.ask)}
                        </div>
                      </td>
                      <td className="px-6 py-4 text-right">
                        <div className={`text-lg font-bold flex items-center justify-end gap-1 ${
                          market.absSpread > 1 ? 'text-green-400' : 
                          market.absSpread > 0.5 ? 'text-yellow-400' : 'text-gray-400'
                        }`}>
                          {market.spread > 0 ? <TrendingUp size={18} /> : <TrendingDown size={18} />}
                          {market.absSpread.toFixed(2)}%
                        </div>
                      </td>
                      <td className="px-6 py-4 text-right text-purple-200">
                        <div>P: ${formatVolume(market.paradex.volume)}</div>
                        <div className="text-xs">E: ${formatVolume(market.extended.volume)}</div>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-8 text-center text-purple-300 text-sm">
          <p>Les données sont actualisées toutes les 30 secondes</p>
          <p className="mt-1">⚠️ Ceci est un outil d'information uniquement. Vérifiez toujours les prix avant de trader.</p>
        </div>
      </div>
    </div>
  );
};

export default App;
